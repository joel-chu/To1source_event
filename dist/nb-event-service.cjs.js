"use strict";var NB_EVENT_SERVICE_PRIVATE_STORE=new WeakMap,NB_EVENT_SERVICE_PRIVATE_LAZY=new WeakMap;function hashCode(e){return e.split("").reduce((function(e,t){return(e=(e<<5)-e+t.charCodeAt(0))&e}),0)}function hashCode2Str(e){return hashCode(e)+""}var SuspendClass=function(){this.__suspend__=null,this.queueStore=new Set},prototypeAccessors={$suspend:{configurable:!0},$queues:{configurable:!0}};prototypeAccessors.$suspend.set=function(e){var t=this;if("boolean"!=typeof e)throw new Error("$suspend only accept Boolean value!");var r=this.__suspend__;this.__suspend__=e,this.logger("($suspend)","Change from "+r+" --\x3e "+e),!0===r&&!1===e&&setTimeout((function(){t.release()}),1)},SuspendClass.prototype.$queue=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return!0===this.__suspend__&&(this.logger("($queue)","added to $queue",e),this.queueStore.add(e)),this.__suspend__},prototypeAccessors.$queues.get=function(){var e=this.queueStore.size;return this.logger("($queues)","size: "+e),e>0?Array.from(this.queueStore):[]},SuspendClass.prototype.release=function(){var e=this,t=this.queueStore.size;if(this.logger("(release)","Release was called "+t),t>0){var r=Array.from(this.queueStore);this.queueStore.clear(),this.logger("queue",r),r.forEach((function(t){e.logger(t),Reflect.apply(e.$trigger,e,t)})),this.logger("Release size "+this.queueStore.size)}},Object.defineProperties(SuspendClass.prototype,prototypeAccessors);var NbEventServiceBase=function(e){function t(t){void 0===t&&(t={}),e.call(this),t.logger&&"function"==typeof t.logger&&(this.logger=t.logger),this.keep=t.keep,this.result=t.keep?[]:null,this.normalStore=new Map,this.lazyStore=new Map}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={is:{configurable:!0},normalStore:{configurable:!0},lazyStore:{configurable:!0}};return r.is.get=function(){return"nb-event-service"},t.prototype.validateEvt=function(){for(var e=this,t=[],r=arguments.length;r--;)t[r]=arguments[r];return t.forEach((function(t){if("string"!=typeof t)throw e.logger("(validateEvt)",t),new Error("event name must be string type!")})),!0},t.prototype.validate=function(e,t){if(this.validateEvt(e)&&"function"==typeof t)return!0;throw new Error("callback required to be function type!")},t.prototype.validateType=function(e){return!!["on","only","once","onlyOnce"].filter((function(t){return e===t})).length},t.prototype.run=function(e,t,r){this.logger("(run)",e,t,r),this.$done=Reflect.apply(e,r,this.toArray(t))},t.prototype.takeFromStore=function(e,t){void 0===t&&(t="lazyStore");var r=this[t];if(r){if(this.logger("(takeFromStore)",t,r),r.has(e)){var o=r.get(e);return this.logger("(takeFromStore)","has "+e,o),r.delete(e),o}return!1}throw new Error(t+" is not supported!")},t.prototype.addToStore=function(e,t){for(var r,o=[],n=arguments.length-2;n-- >0;)o[n]=arguments[n+2];if(e.has(t)?(this.logger("(addToStore)",t+" existed"),r=e.get(t)):(this.logger("(addToStore)","create new Set for "+t),r=new Set),o.length>2)if(Array.isArray(o[0])){var i=o[2];this.checkTypeInLazyStore(t,i)||r.add(o)}else this.checkContentExist(o,r)||(this.logger("(addToStore)","insert new",o),r.add(o));else r.add(o);return e.set(t,r),[e,r.size]},t.prototype.checkContentExist=function(e,t){return!!Array.from(t).filter((function(t){return t[0]===e[0]})).length},t.prototype.checkTypeInStore=function(e,t){this.validateEvt(e,t);var r=this.$get(e,!0);return!1===r||!r.filter((function(e){var r=e[3];return t!==r})).length},t.prototype.checkTypeInLazyStore=function(e,t){this.validateEvt(e,t);var r=this.lazyStore.get(e);return this.logger("(checkTypeInLazyStore)",r),!!r&&!!Array.from(r).filter((function(e){return e[2]!==t})).length},t.prototype.addToNormalStore=function(e,t,r,o){if(void 0===o&&(o=null),this.logger("(addToNormalStore)",e,t,"try to add to normal store"),this.checkTypeInStore(e,t)){this.logger("(addToNormalStore)",t+" can add to "+e+" normal store");var n=this.hashFnToKey(r),i=[this.normalStore,e,n,r,o,t],a=Reflect.apply(this.addToStore,this,i),s=a[0],l=a[1];return this.normalStore=s,l}return!1},t.prototype.addToLazyStore=function(e,t,r,o){void 0===t&&(t=[]),void 0===r&&(r=null),void 0===o&&(o=!1);var n=[this.lazyStore,e,this.toArray(t),r];o&&n.push(o);var i=Reflect.apply(this.addToStore,this,n),a=i[0],s=i[1];return this.lazyStore=a,s},t.prototype.toArray=function(e){return Array.isArray(e)?e:[e]},r.normalStore.set=function(e){NB_EVENT_SERVICE_PRIVATE_STORE.set(this,e)},r.normalStore.get=function(){return NB_EVENT_SERVICE_PRIVATE_STORE.get(this)},r.lazyStore.set=function(e){NB_EVENT_SERVICE_PRIVATE_LAZY.set(this,e)},r.lazyStore.get=function(){return NB_EVENT_SERVICE_PRIVATE_LAZY.get(this)},t.prototype.hashFnToKey=function(e){return hashCode2Str(e.toString())},Object.defineProperties(t.prototype,r),t}(SuspendClass),EventService=function(e){function t(t){void 0===t&&(t={}),e.call(this,t)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={$done:{configurable:!0}};return t.prototype.logger=function(){},t.prototype.$on=function(e,t,r){var o=this;void 0===r&&(r=null);this.validate(e,t);var n=this.takeFromStore(e);if(!1===n)return this.logger("($on)",e+" callback is not in lazy store"),this.addToNormalStore(e,"on",t,r);this.logger("($on)",e+" found in lazy store");var i=0;return n.forEach((function(n){var a=n[0],s=n[1],l=n[2];if(l&&"on"!==l)throw new Error("You are trying to register an event already been taken by other type: "+l);o.logger("($on)","call run on "+e),o.run(t,a,r||s),i+=o.addToNormalStore(e,"on",t,r||s)})),i},t.prototype.$once=function(e,t,r){void 0===r&&(r=null),this.validate(e,t);var o=this.takeFromStore(e);this.normalStore;if(!1===o)return this.logger("($once)",e+" not in the lazy store"),this.addToNormalStore(e,"once",t,r);this.logger("($once)",o);var n=Array.from(o)[0],i=n[0],a=n[1],s=n[2];if(s&&"once"!==s)throw new Error("You are trying to register an event already been taken by other type: "+s);this.logger("($once)","call run for "+e),this.run(t,i,r||a),this.$off(e)},t.prototype.$only=function(e,t,r){var o=this;void 0===r&&(r=null),this.validate(e,t);var n=!1,i=this.takeFromStore(e);(this.normalStore.has(e)||(this.logger("($only)",e+" add to store"),n=this.addToNormalStore(e,"only",t,r)),!1!==i)&&(this.logger("($only)",e+" found data in lazy store to execute"),Array.from(i).forEach((function(n){var i=n[0],a=n[1],s=n[2];if(s&&"only"!==s)throw new Error("You are trying to register an event already been taken by other type: "+s);o.logger("($only)","call run for "+e),o.run(t,i,r||a)})));return n},t.prototype.$onlyOnce=function(e,t,r){void 0===r&&(r=null),this.validate(e,t);var o=!1,n=this.takeFromStore(e);if(this.normalStore.has(e)||(this.logger("($onlyOnce)",e+" add to store"),o=this.addToNormalStore(e,"onlyOnce",t,r)),!1!==n){this.logger("($onlyOnce)",n);var i=Array.from(n)[0],a=i[0],s=i[1],l=i[2];if(l&&"onlyOnce"!==l)throw new Error("You are trying to register an event already been taken by other type: "+l);this.logger("($onlyOnce)","call run for "+e),this.run(t,a,r||s),this.$off(e)}return o},t.prototype.$replace=function(e,t,r,o){if(void 0===r&&(r=null),void 0===o&&(o="on"),this.validateType(o)){this.$off(e);var n=this["$"+o];return this.logger("($replace)",e,t),Reflect.apply(n,this,[e,t,r])}throw new Error(o+" is not supported!")},t.prototype.$trigger=function(e,t,r,o){void 0===t&&(t=[]),void 0===r&&(r=null),void 0===o&&(o=!1),this.validateEvt(e);var n=0,i=this.normalStore;if(this.logger("($trigger)","normalStore",i),i.has(e)){var a=this.$queue(e,t,r,o);if(this.logger("($trigger)",e,"found; add to queue: ",a),!0===a)return this.logger("($trigger)",e,"not executed. Exit now."),!1;for(var s=Array.from(i.get(e)),l=s.length,u=!1,h=0;h<l;++h){++n;var c=s[h],p=(c[0],c[1]),g=c[2],f=c[3];this.logger("($trigger)","call run for "+e),this.run(p,t,r||g),"once"!==f&&"onlyOnce"!==f||(u=!0)}return u&&i.delete(e),n}return this.addToLazyStore(e,t,r,o),n},t.prototype.$call=function(e,t,r,o){void 0===r&&(r=!1),void 0===o&&(o=null);var n=[e,t,o,r];return Reflect.apply(this.$trigger,this,n)},t.prototype.$off=function(e){var t=this;this.validateEvt(e);var r=[this.lazyStore,this.normalStore],o=!1;return r.forEach((function(r){r.has(e)&&(o=!0,t.logger("($off)",e),r.delete(e))})),o},t.prototype.$get=function(e,t){void 0===t&&(t=!1),this.validateEvt(e);var r=this.normalStore;return!!r.has(e)&&Array.from(r.get(e)).map((function(e){if(t)return e;e[0];return e[1]}))},r.$done.set=function(e){this.logger("($done)","value: ",e),this.keep?this.result.push(e):this.result=e},r.$done.get=function(){return this.keep?(this.logger("(get $done)",this.result),this.result[this.result.length-1]):this.result},Object.defineProperties(t.prototype,r),t}(NbEventServiceBase);module.exports=EventService;
//# sourceMappingURL=nb-event-service.cjs.js.map
